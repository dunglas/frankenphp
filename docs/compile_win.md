# Compile From Source on windows

Frankenphp could only dynamic compiled on Windows system. It is still in dev. This steps to compile blew.

## Prepare MSYS2 and FrankenPHP source

Click [msys2-x86_64-20240507.exe](https://github.com/msys2/msys2-installer/releases/download/2024-05-07/msys2-x86_64-20240507.exe) dowload and install it in `C:\`, then its `C:\msys64`. We use environment 'MSYS2 MINGW64'.

### Install basic tools

```bash
# mingw64/msys2 bash
pacman -S git
pacman -S vim
pacman -S make
pacman -S wget
```

### Install gcc

```bash
# mingw64/msys2 bash
# TODO: Check out that why other gcc versions are not able to compile frankenphp
pacman -U https://repo.msys2.org/mingw/mingw64/mingw-w64-x86_64-gcc-13.2.0-6-any.pkg.tar.zst
```

### Setup go

```bash
# mingw64/msys2 bash
# TODO: Better install this version
pacman -U https://mirror.msys2.org/mingw/mingw64/mingw-w64-x86_64-go-1.22.2-1-any.pkg.tar.zst

# set go env
export GO111MODULE='on'
export GOBIN='/home/you-user-name/go/bin'
export GOCACHE='/home/you-user-name/.cache/go-build'
export GOENV='/home/you-user-name/.config/go/env'
export GOROOT="/mingw64/lib/go"
export GOPATH="/home/you-user-name/go"
mkdir ~/go/bin ~/go/pkg ~/go/src
```

### Install brotli
```bash
# mingw64/msys2 bash
pacman -S mingw-w64-x86_64-brotli
```

### Get Frankenphp source

```bash
# mingw64/msys2 bash
cd ~/go/src
git clone https://github.com/dunglas/frankenphp.git
cd frankenphp
git checkout win
```


## Compile PHP

FrankenPHP is compatible with PHP 8.2 and superior. In dev stage, php-8.3.0 recommanded.

### Install PHP-SDK

Recommend reference [build php on windows](https://wiki.php.net/internals/windows/stepbystepbuild_sdk_2).

The first step, you should install visual studio. For php-8.3.0, its visual_studio_2019(vs16). Here are some older [visual studio](https://github.com/user-attachments/files/18225924/visual_studio.zip) releases.  
After visual C++ installed(may need reboot), windows terminal will provide a 'Developer PowerShell for VS 2019'. If not have windows terminal, click [windows terminal](https://aka.ms/terminal).

Then download [php-sdk-binary-tools](https://github.com/php/php-sdk-binary-tools/releases). Unzip it, remove and rename the folder under `C:\`, then its `C:\php-sdk`.  

### Patch, compile, and copy to target path

Enter 'Developer PowerShell for VS 2019', then:  
```
cd C:\php-sdk
.\phpsdk-vs16-x64.bat
phpsdk_buildtree phpdev
# now in C:\php-sdk\phpdev\vs16\x64
git clone -b php-8.3.0 https://github.com/php/php-src.git php-8.3.0
cd php-8.3.0
phpsdk_deps -u -b 8.3
buildconf
# basic configure
configure --with-prefix="C:\php-sdk\phpdev\vs16\x64\php-8.3.0\php" --enable-zts --enable-embed --enable-cli --disable-opcache-jit
COPY C:\msys64\home\TenHian\go\src\frankenphp\patch.php .\
COPY C:\msys64\home\TenHian\go\src\frankenphp\make_dep.bat .\
# modify php-src and Makefile generated by configure
..\..\..\..\bin\php\php.exe patch.php
make
make devel
# modifiy a header file, mv includes and dll in target paths
make_dep.bat
```

## Compile Frankenphp

Back to 'MSYS2 MINGW64'.

```bash
cp /mingw64/lib/libbrotlicommon.a /mingw64/lib/libbrotlidec.a /mingw64/lib/libbrotlienc.a /usr/local/lib
# now you should in ~/go/src/frankenphp
cd caddy/frankenphp
# TODO: compile with watcher
go build -tags nowatcher
# for clean
# go clean && go clean -cache
# for build details
# go build -tags nowatcher -x
```

Now you get frankenphp.exe in `~/go/src/frankenphp/caddy/frankenphp`

## After compile

The frankenphp.exe needs some shared libraries in the same directory to run. Like `libcrypto-3-x64.dll` `libpq.dll` `libssh2.dll` `libssl-3-x64.dll` `libwinpthread-1.dll` `nghttp2.dll` `php_openssl.dll` `php8embed.dll` `php8ts.dll`.   
`libwinpthread-1.dll` in `C:\msys64\mingw64\bin`.  
`libcrypto-3-x64.dll` `libpq.dll` `libssh2.dll` `libssl-3-x64.dll` `nghttp2.dll` in `C:\php-sdk\phpdev\vs16\x64\deps\bin`.  
`php_openssl.dll` `php8embed.dll` `php8ts.dll` in `C:\php-sdk\phpdev\vs16\x64\php-8.3.0\x64\Release_TS`.  
You could use `ldd frankenphp.exe` `ldd php8ts.dll` in 'MSYS2 MINGW64', or `dumpbin /dependents frankenphp.exe` `dumpbin /dependents php8ts.dll` in php-sdk console to see libriaries that need by frankenphp.exe.  
The .dll files start with 'php_' are php extensions, you can find them in `C:\php-sdk\phpdev\vs16\x64\php-8.3.0\x64\Release_TS`. In order to use the extensions, you need to move them to the same path as frankenphp and edit php.ini in this path.

# Principle

First, the windows cgo support MinGW-w64 compiler suite is more complete. In fact all GNU C compilers are relatively ok, but almost all cgo compilation is based on MinGW-w64.  
Second, PHP offical only recommand compile with Visual C++(MSVC).  

So the core problem is to make Mingw-w64 compiler set could link with .dll that PHP on Windows. The `patch.php` does those work, see its comments for more details.