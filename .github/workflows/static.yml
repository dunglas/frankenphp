name: Build binary releases
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-versions: ['8.2']
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Clone static-php-cli/
        run: git clone --depth=1 https://github.com/dunglas/static-php-cli.git --branch=feat/embed

      - id: cache-composer-deps
        name: Download cached Composer
        uses: actions/cache@v3
        with:
          path: static-php-cli/vendor
          key: composer-dependencies

      - if: steps.cache-composer-deps.outputs.cache-hit != 'true'
        name: Install Composer dependencies
        working-directory: static-php-cli/
        run: composer install --no-dev -a

      - id: cache-download
        name: Download cached sources
        uses: actions/cache@v3
        with:
          path: static-php-cli/downloads
          key: php-${{ matrix.php-versions }}-dependencies

      - if: steps.cache-download.outputs.cache-hit != 'true'
        name: Download sources
        working-directory: static-php-cli/
        run: ./bin/spc-alpine-docker download --with-php=${{ matrix.php-versions }} --all

      - name: Build static libraries
        working-directory: static-php-cli/
        run: bin/spc-alpine-docker build --build-embed --enable-zts --debug "bcmath,calendar,ctype,curl,dba,dom,exif,filter,fileinfo,gd,iconv,mbstring,mbregex,mysqli,mysqlnd,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,readline,redis,session,simplexml,sockets,sqlite3,tokenizer,xml,xmlreader,xmlwriter,zip,zlib,apcu"

      - name: Set CGO flags
        working-directory: static-php-cli/
        run: |
          echo "CGO_CFLAGS=$(sh $PWD/source/php-src/scripts/php-config --includes | sed s#-I/include/php#-I$PWD/source/php-src#g)" >> "$GITHUB_ENV"
          echo "CGO_LDFLAGS=-L$PWD/source/php-src/libs $(sh $PWD/source/php-src/scripts/php-config --ldflags | sed s#/app#$PWD#g) $(sh $PWD/source/php-src/scripts/php-config --libs | sed -e 's/-lxml2//g' -e s#/app#$PWD#g)" >> "$GITHUB_ENV"

      - name: Build
        working-directory: caddy/frankenphp/
        run: go build -buildmode=pie -tags "cgo netgo osusergo static_build" -ldflags "-linkmode=external -extldflags -static-pie"

      - uses: actions/upload-artifact@v3
        with:
          name: frankenphp-linux-php-${{ matrix.php-versions }}-dev
          path: caddy/frankenphp/frankenphp

      - name: Run library tests
        run: go test -race -v ./...

      - name: Run Caddy module tests
        working-directory: caddy/
        run: go test -race -v ./...
