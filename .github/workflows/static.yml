name: Build binary releases
on: [push, pull_request]
jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-versions: ['8.2']
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Clone static-php-cli
        run: git clone https://github.com/dunglas/static-php-cli.git --branch=feat/embed

      - name: Install static-php-cli dependencies
        working-directory: static-php-cli
        run: composer install --no-dev -a

      - name: Install missing dependencies
        working-directory: static-php-cli
        run: bin/spc doctor --auto-fix

      - name: Download libraries sources
        working-directory: static-php-cli
        run: bin/spc fetch --with-php=${{ matrix.php-versions }} -A 

      - name: Build static libraries
        working-directory: static-php-cli
        run: bin/spc build --build-embed --enable-zts --debug "bcmath,calendar,ctype,curl,dba,dom,exif,filter,fileinfo,gd,iconv,mbstring,mbregex,mysqli,mysqlnd,openssl,pcntl,pdo,pdo_mysql,pdo_sqlite,phar,posix,readline,redis,session,simplexml,sockets,sqlite3,tokenizer,xml,xmlreader,xmlwriter,zip,zlib,apcu"

      - name: Set CGO flags
        working-directory: static-php-cli
        run: |
          echo "CGO_CFLAGS=-I$PWD/source/php-src -I$PWD/source/php-src/main -I$PWD/source/php-src/TSRM -I$PWD/source/php-src/Zend -I$PWD/source/php-src/ext -I$PWD/source/php-src/ext/date/lib" >> "$GITHUB_ENV"
          echo "CGO_LDFLAGS=-L$PWD/source/php-src/libs $(sh $PWD/source/php-src/scripts/php-config --ldflags) $(sh $PWD/source/php-src/scripts/php-config --libs | sed 's/-lgcc_s//g' | tr ' ' '\n' | sort -u | xargs)" >> "$GITHUB_ENV"

      - name: Build
        working-directory: caddy/frankenphp/
        run: go build -buildmode=pie -tags "cgo netgo osusergo static_build" -ldflags "-linkmode=external -extldflags -static-pie"

      - uses: actions/upload-artifact@v3
        with:
          name: frankenphp-linux-php-${{ matrix.php-versions }}-dev
          path: caddy/frankenphp/frankenphp

      - name: Run library tests
        run: go test -race -v ./...

      - name: Run Caddy module tests
        working-directory: caddy/
        run: go test -race -v ./...
